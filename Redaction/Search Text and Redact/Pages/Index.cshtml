@page
@model IndexModel
@{
    ViewData["Title"] = "Search text and redact";
}
<div class="content-wrapper">
    <div style="margin-bottom:8px; display:flex; gap:8px; align-items:center;">
        <button id="searchTextRedact" type="button" onclick="searchTextAndRedact()">Search "syncfusion" & Mark for Redaction</button>
        <button id="applyRedaction" type="button" onclick="applyRedaction()">Apply Redaction</button>
    </div>

    <ejs-pdfviewer
        id="pdfViewer"
        style="height:640px; display:block"
        resourceUrl="https://cdn.syncfusion.com/ej2/31.2.12/dist/ej2-pdfviewer-lib"
        documentPath="https://cdn.syncfusion.com/content/pdf/pdf-succinctly.pdf"
        isExtractText="true">
    </ejs-pdfviewer>
</div>
<script type="text/javascript">
    window.onload = function () {
        window.viewer = document.getElementById('pdfViewer').ej2_instances[0];
        // Primary toolbar including Redaction
        viewer.toolbarSettings = {
            toolbarItems: [
                'OpenOption', 'UndoRedoTool', 'PageNavigationTool', 'MagnificationTool', 'PanTool',
                'SelectionTool', 'CommentTool', 'SubmitForm', 'AnnotationEditTool', 'RedactionEditTool',
                'FormDesignerEditTool', 'SearchOption', 'PrintOption', 'DownloadOption'
            ]
        };
    };

    // Finds "syncfusion" and adds redaction annotations for each match
    async function searchTextAndRedact() {
        if (!window.viewer) return;
        var term = 'syncfusion';
        try {
            var results = await viewer.textSearchModule.findTextAsync(term, false);
            if (!results || results.length === 0) {
                console.warn('No matches found.');
                return;
            }
            var px = function (pt) { return (pt * 96) / 72; };
            for (var i = 0; i < results.length; i++) {
                var pageResult = results[i];
                if (!pageResult || !pageResult.bounds || pageResult.bounds.length === 0) continue;
                if (pageResult.pageIndex == null) continue;
                var pageNumber = pageResult.pageIndex + 1; // 1-based
                for (var b = 0; b < pageResult.bounds.length; b++) {
                    var bound = pageResult.bounds[b];
                    viewer.annotation.addAnnotation('Redaction', {
                        bound: {
                            x: px(bound.x),
                            y: px(bound.y),
                            width: px(bound.width),
                            height: px(bound.height)
                        },
                        pageNumber: pageNumber,
                        overlayText: 'Confidential',
                        fillColor: '#00FF40FF',
                        fontColor: '#333333',
                        fontSize: 12,
                        fontFamily: 'Arial',
                        markerFillColor: '#FF0000',
                        markerBorderColor: '#000000'
                    });
                }
            }
        } catch (e) {
            console.error('Search failed:', e);
        }
    }

    // Permanently applies all redaction marks in the document
    function applyRedaction() {
        if (!window.viewer) return;
        viewer.annotation.redact();
    }
</script>